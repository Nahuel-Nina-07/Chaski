name: Build, Test & Deploy to MonsterASP.NET

on:
  push:
    branches:
      - develop # O la rama que uses para desplegar

jobs:
  build-test-deploy:
    runs-on: windows-latest

    steps:
      - name: 🧾 Clonar repositorio
        uses: actions/checkout@v4

      - name: 🛠️ Configurar .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.0.x"

      - name: 📦 Restaurar paquetes
        run: dotnet restore

      - name: 🧪 Compilar la solución
        run: dotnet build --no-restore --configuration Release

      - name: 🧪 Ejecutar tests
        run: dotnet test --no-build --configuration Release --verbosity normal

      - name: 📤 Publicar proyecto
        run: dotnet publish --configuration Release -o ./publish

      - name: 🚀 Desplegar a MonsterASP.NET
        if: success()
        uses: rasmusbuchholdt/simply-web-deploy@2.1.0
        with:
          website-name: ${{ secrets.WEBSITE_NAME }}
          server-computer-name: ${{ secrets.WEBDEPLOY_SERVER }}
          server-username: ${{ secrets.WEBDEPLOY_USERNAME }}
          server-password: ${{ secrets.WEBDEPLOY_PASSWORD }}

      - name: ✅ Mensaje de éxito
        if: success()
        run: echo "🚀 ¡Despliegue a MonsterASP.NET completado exitosamente!"

      - name: ❌ Mensaje de error
        if: failure()
        run: echo "❌ Error en build, test o deploy. Revisa los logs en la pestaña Actions."

      - name: 🔔 Notificación Slack (opcional)
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}
          SLACK_USERNAME: Chaski CI/CD
          SLACK_TITLE: "Despliegue a MonsterASP.NET"
          SLACK_MESSAGE: ${{ job.status == 'success' && '✅ Se desplegó exitosamente.' || '❌ Falló el despliegue. Revisa los logs en GitHub Actions.' }}
          SLACK_ICON: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
