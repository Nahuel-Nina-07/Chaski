name: Deploy API to MonsterASP.NET with Notifications

on:
  push:
    branches: [ "develop" ]  # Solo se activa con pushes a develop

jobs:
  deploy-and-notify:
    runs-on: windows-latest
    steps:
      # --- Paso 1: Checkout del código ---
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Paso 2: Compilar la API (.NET) ---
      - name: Build .NET API
        run: |
          dotnet restore
          dotnet publish -c Release -o ./publish

      # --- Paso 3: Desplegar en MonsterASP.NET ---
      - name: Deploy to MonsterASP.NET
        uses: rasmusbuchholdt/simply-web-deploy@2.1.0
        with:
          website-name: ${{ secrets.WEBSITE_NAME }}
          server-computer-name: ${{ secrets.SERVER_COMPUTER }}
          server-username: ${{ secrets.SERVER_USERNAME }}
          server-password: ${{ secrets.SERVER_PASSWORD }}
          source-path: './publish'
          target-delete: true

      - name: Prepare Slack Notification
        id: prepare-slack-notification
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "SLACK_TITLE=✅ Despliegue exitoso (develop)" >> $GITHUB_ENV
            echo "SLACK_MESSAGE=La API se ha desplegado correctamente en MonsterASP.NET. Commit: ${{ github.sha }}" >> $GITHUB_ENV
            echo "SLACK_COLOR=good" >> $GITHUB_ENV
          else
            echo "SLACK_TITLE=❌ Error en despliegue (develop)" >> $GITHUB_ENV
            echo "SLACK_MESSAGE=Hubo un problema al desplegar la API. Revisa los logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
            echo "SLACK_COLOR=danger" >> $GITHUB_ENV
          fi

      - name: Send Slack Notification
        if: always()  # Notifica siempre, incluso si falla
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: ${{ env.SLACK_COLOR }}
          SLACK_TITLE: ${{ env.SLACK_TITLE }}
          SLACK_MESSAGE: ${{ env.SLACK_MESSAGE }}
          SLACK_USERNAME: "Backend Chaski"
